<?php 
function getConnection() 
{
	 
	$dbhost = "schoolforms.cjahuqpumuov.us-east-1.rds.amazonaws.com";
	$dbname = "mzrdb";
	$dbuser = "schoolforms";
	$dbpass = "melosh123";
    $dbh = new PDO("mysql:host=$dbhost;dbname=$dbname", $dbuser, $dbpass);
  $dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
  return $dbh;
}

$db =getConnection();


header('Access-Control-Allow-Origin: *');

 if(!empty($_FILES["excel_file"]))  
 { 

      $admin = $_POST['admin'];
      $doctype = $_POST['doctype'];
	  $LPType = $_POST['LPType'];
	  $ResturantID = $_POST['location'];
	  $file_path = "";

	  $file_array = explode(".", $_FILES["excel_file"]["name"]);  
	  
	   $info = pathinfo($_FILES['excel_file']['name']);
		$ext = $info['extension']; // get the extension of the file
		$newname = "licensePermit.".$ext; 
		$target = 'images/'.$newname;
		move_uploaded_file( $_FILES['excel_file']['tmp_name'], $target);
		
      
	  if($file_array[1] == "xls")  
      {  
           include("PHPExcel/Classes/PHPExcel/IOFactory.php");  
           $object = PHPExcel_IOFactory::load($target);  
           foreach($object->getWorksheetIterator() as $worksheet)  
           {  
                $highestRow = $worksheet->getHighestRow();  
                for($row=2; $row<=$highestRow; $row++)  
                {  
						$license = $worksheet->getCellByColumnAndRow(1, $row)->getValue();  
						$comments = $worksheet->getCellByColumnAndRow(2, $row)->getValue();  
						$IssuanceDate = $worksheet->getCellByColumnAndRow(3, $row)->getValue();  
						$ExpirationDate = $worksheet->getCellByColumnAndRow(4, $row)->getValue();

						$IssuanceDate = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($IssuanceDate));
						$ExpirationDate = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($ExpirationDate));
						
					
						
									
			$statement= $db->prepare('INSERT INTO schoolforms.rcm_license_permit_v2 (license, comments, lp_file_path, IssuanceDate, ExpirationDate,admin,LocationID,doctype,LPType) VALUES (?,?,?,?,?,?,?,?,?)');
	$arr1 = array();
	array_push($arr1,$license,$comments,$file_path,$IssuanceDate,$ExpirationDate,$admin,$ResturantID,$doctype,$LPType);
	
	if($statement->execute($arr1))
	{
		//echo json_encode("success");
	}
	else {
		//echo json_encode("error");
		}
						
                   
    }  
				
			
           }  
        echo json_encode(1);  
        unlink($target);
      }  
      else  
      {  
          // echo '<label class="text-danger">Invalid File</label>'; 
		  echo json_encode(2); 
      }  
 }  
 ?>  