<?php

header('Access-Control-Allow-Origin: *');  
include("class.phpmailer.php");
$db =getConnection();

 
function Docs($db)
{  

	$statement= $db->prepare("select * FROM schoolforms.rcm_users_v2");
 	$statement->execute();
	if($data=$statement->fetchAll(PDO::FETCH_ASSOC))
	{	

	$Totallp =array('ABC Manger License','Business License','Food Safety Facility Permit','Liquor License');
	$Totalcertificate = array('TIPs Certification','Certificate of Occupancy','Food Service Manager Certification','Food Safety Handler Certification');
	$TotalInspection =array('Health Inspection');


      $statementRes =  $db->prepare("SELECT * FROM schoolforms.rcm_restaurant_v2");
	  $statementRes->execute();
	  if($dataRest=$statementRes->fetchAll(PDO::FETCH_ASSOC))
	  {	
	   $ResData=array();

	   foreach($dataRest as $r){
		   
			$idR = array("adminR" => $r['id']);
			array_push($ResData,$r['id'],$r['restaurant_name'],$r['user']);
			
	   foreach($data as $d)
		{
				$id = array("admin" => $d['id'],"adminR" => $r['id']);
				$UserData=array();
				array_push($UserData,$d['id'],$d['fname'],$d['email']);

				$UTotalcertificate = $Totalcertificate;
				$UTotalLP = $Totallp;
				$UTotalInspection = $TotalInspection;

			// rcm_certification
			$statement1= $db->prepare("SELECT DISTINCT (rcm_certification_v2.certification)FROM schoolforms.rcm_certification_v2 LEFT JOIN schoolforms.rcm_employee_v2 on rcm_certification_v2.employeeID=rcm_employee_v2.id LEFT join schoolforms.rcm_restaurant_v2 on rcm_employee_v2.resturant_id=rcm_restaurant_v2.id WHERE rcm_certification_v2.admin=:admin and rcm_restaurant_v2.id=:adminR");
			
			$statement1->execute($id);
			if($certification=$statement1->fetchAll(PDO::FETCH_ASSOC))
			{
				foreach($certification as $c)
				{
 					if (($key = array_search($c['certification'], $UTotalcertificate)) !== false) {
					    unset($UTotalcertificate[$key]);
					}
				}
			} 
			//array_push($UTotalcertificate,$r['restaurant_name']);
			//print_r($UTotalcertificate);

		  $statement2= $db->prepare("SELECT DISTINCT (rcm_license_permit_v2.license) FROM schoolforms.rcm_license_permit_v2 LEFT JOIN schoolforms.rcm_employee_v2 on rcm_license_permit_v2.employeeID=rcm_employee_v2.id LEFT join schoolforms.rcm_restaurant_v2 on rcm_employee_v2.resturant_id=rcm_restaurant_v2.id WHERE rcm_license_permit_v2.admin=:admin and  rcm_restaurant_v2.id=:adminR");
			$statement2->execute($id);
			if($certification2=$statement2->fetchAll(PDO::FETCH_ASSOC))
			{
				foreach($certification2 as $c2)
				{
					if (($key2 = array_search($c2['license'], $UTotalLP)) !== false) {
					    unset($UTotalLP[$key2]);
					}
				}
			} 

			// TotalInspection
			$statement3= $db->prepare("SELECT DISTINCT (rcm_inspection_v2.inspection) FROM schoolforms.rcm_inspection_v2 LEFT JOIN schoolforms.rcm_employee_v2 on rcm_inspection_v2.employeeID=rcm_employee_v2.id LEFT join schoolforms.rcm_restaurant_v2 on rcm_employee_v2.resturant_id=rcm_restaurant_v2.id WHERE rcm_inspection_v2.admin=:admin and  rcm_restaurant_v2.id=:adminR");
			$statement3->execute($id);
			if($certification3=$statement3->fetchAll(PDO::FETCH_ASSOC))
			{
				foreach($certification3 as $c3)
				{
					if (($key3 = array_search($c3['inspection'], $UTotalInspection)) !== false) {
					    unset($UTotalInspection[$key3]);
					}
				}
			} 
			
		array_push($UserData,$UTotalInspection);
		array_push($UserData,$UTotalcertificate);
		array_push($UserData,$UTotalLP);
		
		array_push($UserData,$r['restaurant_name']);
		
		print_r($UserData);
		
			
				
				
		
		    
  
		}
		
			
			//sendEmail($UserData,$db);
			
			 
		  
		   
		   }
		  
	  
	  }
	  
	  




  
  

		
   	}  	
} 
 
 //30 Days Pool  
function sendEmail($emailData,$db)
{
	//print_r($emailData);
	$userID=$emailData[0];
	$fname=$emailData[1];
	$email=$emailData[2];
	$ResName=$emailData[6];
 	 unset($emailData[0]);
	 unset($emailData[1]);
	 unset($emailData[2]);
	 $data=""; 

 	 foreach($emailData as $d =>$val)
	 {
		 if (is_array($val) || is_object($val))
        {
			foreach($val as $KL)
			{
			$data .="<li>".$KL."</li>";
			}
		}
	 }	 
   
  
  	$mail = new PHPMailer();  
	$mail->From ="info@complyance.net";
	$mail->FromName ="COMPLYANCE"; 
	$mail->addReplyTo("noreply@complyance.net", "COMPLYANCE");
	$mail->isHTML(true);
	$mail->Subject = "Missing Items for ".$ResName." ";
 	$mail->AltBody = "Error"; 
 
 	$mail->AddAddress($email, $fname);
	$mail->Body = "Hi ".$fname.", <br/><br/> Please see below the un-entered items. 
	<br/><br/>
	<ol>".$data."</ol>
	<a href='http://complyance.net/tool/'>Click here</a> to access COMPLYANCE and enter the missing items.<br/><br/>Thank You.";
	
	if(!$mail->Send()) 
	{
		echo json_encode("Error");
	} 
	else 
	{  		
		echo json_encode("Success");
	}
	 
}
 
 

 Docs($db);
?>

<?php
  /*$statementRes= $db->prepare("SELECT * FROM schoolforms.rcm_restaurant_v2");
  $statementRes->execute();

SELECT DISTINCT (rcm_certification_v2.certification)FROM schoolforms.rcm_certification_v2 LEFT JOIN schoolforms.rcm_employee_v2 on rcm_certification_v2.employeeID=rcm_employee_v2.id LEFT join schoolforms.rcm_restaurant_v2 on rcm_employee_v2.resturant_id=rcm_restaurant_v2.id WHERE rcm_certification_v2.admin=:admin and  rcm_restaurant_v2.id=21
*/?>