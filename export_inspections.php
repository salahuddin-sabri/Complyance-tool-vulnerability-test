<?php 
   
function getConnection() 
{
	 
	$dbhost = "schoolforms.cjahuqpumuov.us-east-1.rds.amazonaws.com";
	$dbname = "mzrdb";
	$dbuser = "schoolforms";
	$dbpass = "melosh123";
    $dbh = new PDO("mysql:host=$dbhost;dbname=$dbname", $dbuser, $dbpass);
  $dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
  return $dbh;
}

$db =getConnection();


header('Access-Control-Allow-Origin: *');

 if(!empty($_FILES["excel_file"]))  
 { 

      $admin = $_POST['admin'];
	  $LocationID =$_POST['location'];
	  $insp_file_path= ""; 
      $file_array = explode(".", $_FILES["excel_file"]["name"]);  
	  
	  
	       $info = pathinfo($_FILES['excel_file']['name']);
			$ext = $info['extension']; // get the extension of the file
			$newname = "inspection.".$ext; 
			$target = 'images/'.$newname;
			move_uploaded_file( $_FILES['excel_file']['tmp_name'], $target);
			
			
      if($file_array[1] == "xls")  
      {  
           include("PHPExcel/Classes/PHPExcel/IOFactory.php");  
           $object = PHPExcel_IOFactory::load($target);
		     
           foreach($object->getWorksheetIterator() as $worksheet)  
           {  
                $highestRow = $worksheet->getHighestRow();  
                for($row=2; $row<=$highestRow; $row++)  
                {  
						$Inspector_Name = $worksheet->getCellByColumnAndRow(1, $row)->getValue();  
						$Inspection = $worksheet->getCellByColumnAndRow(2, $row)->getValue();  
						$Date_of_Inspection = $worksheet->getCellByColumnAndRow(3, $row)->getValue();  
						$Is_Follow_Up = $worksheet->getCellByColumnAndRow(4, $row)->getValue();
						$Follow_Up_Date = $worksheet->getCellByColumnAndRow(5, $row)->getValue();
						$Comments = $worksheet->getCellByColumnAndRow(6, $row)->getValue();
						
						//$Date_of_Inspection = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($Date_of_Inspection));
						
			$statement= $db->prepare('INSERT INTO schoolforms.rcm_inspection_v2
	(inspection, date_of_inspection, comments, insp_file_path, admin, is_followUp, followUp_date, InspectorName, LocationID) VALUES (?,?,?,?,?,?,?,?,?)');
	$arr = array();
	array_push($arr,$Inspection,$Date_of_Inspection,$Comments,$insp_file_path,$admin,$Is_Follow_Up,$Follow_Up_Date,$Inspector_Name,$LocationID);
	if($statement->execute($arr))
	{
		//echo json_encode("success");
	}
	else {
		//echo json_encode("error");
		}
						
                   
                }  
				
			
           }  
        echo json_encode(1);  
		unlink($target);
        
      }  
      else  
      {  
          // echo '<label class="text-danger">Invalid File</label>'; 
		  echo json_encode(2); 
      }  
 }  
 ?>  