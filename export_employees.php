<?php 
   
function getConnection() 
{
	 
	$dbhost = "schoolforms.cjahuqpumuov.us-east-1.rds.amazonaws.com";
	$dbname = "mzrdb";
	$dbuser = "schoolforms";
	$dbpass = "melosh123";
    $dbh = new PDO("mysql:host=$dbhost;dbname=$dbname", $dbuser, $dbpass);
  $dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
  return $dbh;
}

$db =getConnection();


header('Access-Control-Allow-Origin: *');

 if(!empty($_FILES["excel_file"]))  
 { 

     
      $admin = $_POST['admin'];
      $ResturantID = $_POST['location'];
	  $file_path= ""; 
	  $file_array = explode(".", $_FILES["excel_file"]["name"]);  
	 
	  include("PHPExcel/Classes/PHPExcel/IOFactory.php"); 
	  include("PHPExcel/Classes/PHPExcel.php");
	
	  
	    	$info = pathinfo($_FILES['excel_file']['name']);
			$ext = $info['extension']; // get the extension of the file
			$newname = "employees.".$ext; 
			$target = 'images/'.$newname;
			move_uploaded_file( $_FILES['excel_file']['tmp_name'], $target);
			
			
	  if($file_array[1] == "xls")  
      {  
           //include("PHPExcel/Classes/PHPExcel/IOFactory.php"); 
           $object = PHPExcel_IOFactory::load($target); 
		   
		 
		 
           foreach($object->getWorksheetIterator() as $worksheet)  
           {  
                $highestRow = $worksheet->getHighestRow();  
                for($row=2; $row<=$highestRow; $row++)  
                {  
						$emp_name = $worksheet->getCellByColumnAndRow(1, $row)->getValue();  
						$emp_email = $worksheet->getCellByColumnAndRow(2, $row)->getValue();  
						$department = $worksheet->getCellByColumnAndRow(3, $row)->getValue();  
						$title = $worksheet->getCellByColumnAndRow(4, $row)->getValue();
						$education = $worksheet->getCellByColumnAndRow(5, $row)->getValue();
						$joining_date = $worksheet->getCellByColumnAndRow(6, $row)->getValue();
						$probation_period = $worksheet->getCellByColumnAndRow(7, $row)->getValue();
						$dob = $worksheet->getCellByColumnAndRow(8, $row)->getValue();
						$employee_id = $worksheet->getCellByColumnAndRow(9, $row)->getValue();
						$comments = $worksheet->getCellByColumnAndRow(10, $row)->getValue();
						
					
						
						
						$joining_date = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($joining_date));
						$probation_period = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($probation_period));
						$dob = date('Y-m-d', PHPExcel_Shared_Date::ExcelToPHP($dob));
									
			$statement= $db->prepare('INSERT INTO schoolforms.rcm_employee_v2
	(emp_name, emp_email, department, title, education, joining_date, probation_period, dob, admin, resturant_id, employee_id, comments, file)
VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)');
	$arr1 = array();
	array_push($arr1,$emp_name,$emp_email,$department,$title,$education,$joining_date,$probation_period,$dob,$admin,$ResturantID,$employee_id,$comments,$file_path);
	
	if($statement->execute($arr1))
	{
		//echo json_encode("success");
	}
	else {
		//echo json_encode("error");
		}
						
                   
    }  
				
			
           }  
        echo json_encode(1);  
		unlink($target); 
        
      }  
      else  
      {  
          // echo '<label class="text-danger">Invalid File</label>'; 
		  echo json_encode(2); 
      }  
 }  
 ?>  